<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Overview &mdash; SureDrop  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/tooltipster.custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/tooltipster.bundle.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/tooltipster-sideTip-shadow.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/tooltipster-sideTip-punk.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/tooltipster-sideTip-noir.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/tooltipster-sideTip-light.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/tooltipster-sideTip-borderless.min.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/micromodal.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/sphinx_prompt_css.css" type="text/css" />
      <link rel="stylesheet" href="../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/sphinx_rtd_theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css\rtd_sphinx_search.min.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/js/hoverxref.js"></script>
        <script src="../_static/js/tooltipster.bundle.min.js"></script>
        <script src="../_static/js/micromodal.min.js"></script>
        <script src="../_static/tabs.js"></script>
        <script src="../_static/js\rtd_sphinx_search.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script src="../_static/js/expand_tabs.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Installing" href="Installing.html" />
    <link rel="prev" title="Identity Providers" href="../integrations/IDP.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html">
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">SureDrop Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../SDOver/SD-overview.html">SureDrop Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">SureDrop Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../install/On%20Premise.html">On Premise Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/Version.html">Select the SureDrop version to Install</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/Common%20configuration%20tasks.html">Common configuration tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/Windows%202016.html">New Install - Windows 2016</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/Windows%202019.html">New Install - Windows 2019</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/SureDropVm.html">New Install - Virtual Machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/Create-cloud-login.html">Create SaaS login</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/Uninstall.html">Uninstall</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/Diagnostics.html">Diagnostics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install/Health%20check.html">Health check</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using SureDrop</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Using/Open%20Application.html">Open Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Using/Create%20Users.html">Create Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Using/Send%20Files.html">Send Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Using/Archiving.html">Archiving</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Integrations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../integrations/IDP.html">Identity Providers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Senetas Key Orchestrator</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#os-support">OS Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="#providers">Providers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#key-encryption-keys-kek">Key Encryption Keys (KEK)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-encryption-key-dek">Data Encryption Key (DEK)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#encryption-walk-though-step-by-step">Encryption walk though step by step</a></li>
<li class="toctree-l2"><a class="reference internal" href="#decryption-walk-though-step-by-step">Decryption walk though step by step</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Installing.html">Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="Running.html">Running</a></li>
<li class="toctree-l1"><a class="reference internal" href="Configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="Providers.html">Providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="Using.html">Using</a></li>
<li class="toctree-l1"><a class="reference internal" href="Suredrop%20Integration.html">SureDrop Integration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Detailed Functionality</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deep/SureDrop-Architectures.html">Architectures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deep/Azure%20Architecture.html">A Standard Azure SureDrop SaaS Implementation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deep/Rest%20API.html">Rest API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deep/Roles.html">Roles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deep/Manually%20Import%20Users.html">Manually Import Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deep/Backup.html">Backup a single stack deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deep/X.509.html">X.509 Certificates</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Material</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/faq.html">❓ Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/known_issues.html">Known Issues</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Enhancements &amp; Amendments</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../release/2.12.html">✨ Version 2.12.0-certified</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release/2.11.x.html">Version 2.11.0-certified</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release/2.10.x.html">Version 2.10.x</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release/2.9.x.html">Version 2.9.x</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release/2.8.x.html">Version 2.8.x</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release/2.7.x.html">Version 2.7.x</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SureDrop</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Overview</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/SKC/Overview.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this headline"></a></h1>
<p>The Senetas Key Orchestrator (SKC) is a stand alone, stateless key orchestration solution designed to support SureDrop in multiple Key Management Solutions (KMS).</p>
<p>While SKC is designed to support SureDrop, it can also be used as a stand alone solution for encryption/decryption of arbitrarily large data using a standardized and modern REST API by abstracting and standardizing multiple back end Key Management Solutions.</p>
<p>Senetas Key Orchestrator (SKC) should be used in the following situations:</p>
<ol class="arabic simple">
<li><p>When Suredrop needs to connect to multiple KMS’s with failover and redundancy</p></li>
<li><p>When Suredrop needs to connect to a KMS in a geographically different region</p></li>
<li><p>Where there is high network latency between SureDrop and the KMS.</p></li>
<li><p>Where KMS availability may not be 100%</p></li>
<li><p>Where KMS performance is an issue</p></li>
<li><p>Where SureDrop needs to connect to KMS’s from different vendors at the same time.</p></li>
<li><p>When a high performance, stateless encryption/decryption solution is required.</p></li>
<li><p>When SureDrop needs to connect to a Luna HSM</p></li>
</ol>
<div class="section" id="os-support">
<h2>OS Support<a class="headerlink" href="#os-support" title="Permalink to this headline"></a></h2>
<p>SKC is written in dotnetcore version 3.1 and supports the following platforms:
1. Windows
2. MacOS
3. Unix</p>
<p>Each platform has differences as follows:</p>
<p>1. Windows
The Windows version supports SKC running as a windows service.
The Windows version supports the Windows Event Log.</p>
<p>2. Unix
The Unix version does not support Luna HSM.</p>
<p>3. MacOS
The MacOS version does not support Luna HSM.</p>
</div>
<div class="section" id="providers">
<h2>Providers<a class="headerlink" href="#providers" title="Permalink to this headline"></a></h2>
<p>Currently SKC supports the following providers:</p>
<ol class="arabic simple">
<li><p>Amazon KMS</p></li>
<li><p>Senetas Key Vault (with support of IDQ Quantis Quantum Random Number Generator)</p></li>
<li><p>Thales SafeNet Luna HSM</p></li>
<li><p>Thales KeySecure (Classic &amp; Nextgen)</p></li>
<li><p>SKC also support itself as a provider.</p></li>
</ol>
</div>
<div class="section" id="key-encryption-keys-kek">
<h2>Key Encryption Keys (KEK)<a class="headerlink" href="#key-encryption-keys-kek" title="Permalink to this headline"></a></h2>
<p>Back end <cite>Providers</cite> are configured in SKC as Key Encryption Key (KEK) providers.</p>
<p>There may be multiple back end providers configured at any time.</p>
<p>All providers are used for the <cite>encrypt</cite> action, but only one provider is required for the <cite>decrypt</cite> action.</p>
<p>The role of the provider is to take a Data Encryption Key (DEK) and to encrypt/decrypt it using the KEK.</p>
<p>Providers are configured with a priority similar to mail servers. Providers will be tried in order of lowest network latency within the same priority group during a decrypt action. Once all providers have been exhausted within a priority group and a successful KEK solution has not been determined to decrypt the DEK, the next level of priority will be searched.</p>
<p>Providers provide named KEK’s, and also provide a wildcard ‘default’ key if no key is named during the encrypt/decrypt action.</p>
</div>
<div class="section" id="data-encryption-key-dek">
<h2>Data Encryption Key (DEK)<a class="headerlink" href="#data-encryption-key-dek" title="Permalink to this headline"></a></h2>
<p>The Data Encryption Key (DEK) is used to encrypt the actual data. The DEK is generated by one of three means:</p>
<ol class="arabic simple">
<li><p>If any of the configured providers support a cryptographically secure random number generator, this will be used to generate the DEK and add it to the random pool.</p></li>
<li><p>If none of the providers support a random function, then a DEK will be generated internally using the RNGCryptoServiceProvider provided by microsoft and added to the random pool.</p></li>
<li><p>A DEK is reused from the random pool. The number of times a DEK can be used is configured globally for the SKC but can be overridden in each request.  While SKC can be configured to use a unique DEK for every request, this can substantially reduce performance. For high performance it is recommended that a new DEK should not be generated more than once a second.</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>eg. For an average of <span class="m">1000</span>/actions per second a limit of
  <span class="m">1000</span> DEK key reuse should be configured.
</pre></div>
</div>
</div>
<div class="section" id="encryption-walk-though-step-by-step">
<h2>Encryption walk though step by step<a class="headerlink" href="#encryption-walk-though-step-by-step" title="Permalink to this headline"></a></h2>
<ol class="arabic simple">
<li><p>Plaintext data is received via the encrypt action REST API POST.
(Data may be binary, JSON or plaintext)</p></li>
<li><p>The data is compressed using standard GZip compression.</p></li>
<li><p>A DEK is generated.</p></li>
<li><p>The in memory cache is then checked to determine if a ciphertext version of the DEK exists for each provider. If a ciphertext version of the DEK already exists then the provider is not queried and the encrypted DEK is returned immediately.</p></li>
<li><p>If the encrypted DEK does not already exist in the cache,  copy of the plaintext DEK is sent to all of the providers in parallel threads requesting that it be encrypted with each individual KEK.</p></li>
<li><p>Multiple copies of the encrypted DEK are returned. Each copy of the DEK is named with the provider <cite>id</cite> and stamped with the timestamp of when it was encrypted and a TTL DEK expiry, it is then converted to base64.</p></li>
<li><p>The compressed Plaintext is encrypted using BouncyCastle with the following parameters:</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>The plaintext DEK <span class="o">(</span>key<span class="o">)</span> and the Username <span class="o">(</span>nonSecretPayload<span class="o">)</span>
</pre></div>
</div>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">EncryptWithKey</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">messageToEncrypt</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">key</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">nonSecretPayload</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//User Error Checks</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">key</span><span class="p">.</span><span class="n">Length</span> <span class="p">!=</span> <span class="n">KEY_BIT_SIZE</span> <span class="p">/</span> <span class="m">8</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Key needs to be {0} bit!&quot;</span><span class="p">,</span> <span class="n">KEY_BIT_SIZE</span><span class="p">),</span> <span class="s">&quot;key&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">//Non-secret Payload Optional</span>
    <span class="n">nonSecretPayload</span> <span class="p">=</span> <span class="n">nonSecretPayload</span> <span class="p">??</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[]</span> <span class="p">{</span> <span class="p">};</span>

    <span class="c1">//Using random nonce large enough not to repeat</span>
    <span class="kt">var</span> <span class="n">nonce</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">NONCE_BIT_SIZE</span> <span class="p">/</span> <span class="m">8</span><span class="p">];</span>
    <span class="n">_random</span><span class="p">.</span><span class="n">NextBytes</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">nonce</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">cipher</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GcmBlockCipher</span><span class="p">(</span><span class="k">new</span> <span class="n">AesFastEngine</span><span class="p">());</span>
    <span class="kt">var</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AeadParameters</span><span class="p">(</span><span class="k">new</span> <span class="n">KeyParameter</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">MAC_BIT_SIZE</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">nonSecretPayload</span><span class="p">);</span>
    <span class="n">cipher</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="k">true</span><span class="p">,</span> <span class="n">parameters</span><span class="p">);</span>

    <span class="c1">//Generate Cipher Text With Auth Tag</span>
    <span class="kt">var</span> <span class="n">cipherText</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">cipher</span><span class="p">.</span><span class="n">GetOutputSize</span><span class="p">(</span><span class="n">messageToEncrypt</span><span class="p">.</span><span class="n">Length</span><span class="p">)];</span>
    <span class="kt">var</span> <span class="n">len</span> <span class="p">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">ProcessBytes</span><span class="p">(</span><span class="n">messageToEncrypt</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">messageToEncrypt</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">cipherText</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
    <span class="n">cipher</span><span class="p">.</span><span class="n">DoFinal</span><span class="p">(</span><span class="n">cipherText</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

    <span class="c1">//Assemble Message</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">combinedStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">binaryWriter</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryWriter</span><span class="p">(</span><span class="n">combinedStream</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">//Prepend Authenticated Payload</span>
            <span class="n">binaryWriter</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">nonSecretPayload</span><span class="p">);</span>
            <span class="c1">//Prepend Nonce</span>
            <span class="n">binaryWriter</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">nonce</span><span class="p">);</span>
            <span class="c1">//Write Cipher Text</span>
            <span class="n">binaryWriter</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="n">cipherText</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">combinedStream</span><span class="p">.</span><span class="n">ToArray</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ol class="arabic simple" start="8">
<li><p>The result is also converted to base64.</p></li>
<li><p>The multiple copies of the encrypted DEK and the ciphertext are combined into a JSON structure with the following format:</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="o">{</span>
        <span class="s2">&quot;keys&quot;</span>:
        <span class="o">[</span>
                <span class="s2">&quot;AAAAAAA==&quot;</span>,
                <span class="s2">&quot;BBBBBBB==&quot;</span>,
                ...
        <span class="o">]</span>,
        <span class="s2">&quot;data&quot;</span>: <span class="s2">&quot;DDDDDDD==&quot;</span>
<span class="o">}</span>
</pre></div>
</div>
<ol class="arabic simple" start="10">
<li><p>This is either returned as a bas64 blob or as a JSON string depending on the input parameters.</p></li>
</ol>
</div>
<div class="section" id="decryption-walk-though-step-by-step">
<h2>Decryption walk though step by step<a class="headerlink" href="#decryption-walk-though-step-by-step" title="Permalink to this headline"></a></h2>
<ol class="arabic simple">
<li><p>The base64 encoded blob or JSON snippet that was returned from the encrypt action is fed back to the SKC decrypt action via a POST and the decrypted keys and data identified.</p></li>
<li><p>The lookup memory cache of SKC is queried to determine if the plaintext DEK exists in the cache. If it is, no providers are queried and the plaintext DEK is returned from memory immediately.</p></li>
<li><p>If the plaintext DEK is not found in the cache, SKC then lists each of the back end KMS providers in order of priority as defined when the provider was created. If two providers have the same priority a small random jitter is introduced to ensure that each provider of the same priority is randomly selected each time.</p></li>
<li><p>Each provider is then sent it’s matching (matched by id) encrypted DEK key in turn to be decrypted by the providers KEK if it exists in the list of encrypted keys, if the key does not exist it is skipped.</p></li>
<li><p>If a provider is able to return the decrypted DEK, then no more providers are queried.</p></li>
<li><p>The decrypted DEK is then used to decrypt the data ciphertext using the following function:</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>The plaintext DEK <span class="o">(</span>key<span class="o">)</span> and the Username <span class="o">(</span>nonSecretPayload<span class="o">)</span>
</pre></div>
</div>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="kt">byte</span><span class="p">[]</span> <span class="nf">DecryptWithKey</span><span class="p">(</span><span class="kt">byte</span><span class="p">[]</span> <span class="n">encryptedMessage</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">key</span><span class="p">,</span> <span class="kt">byte</span><span class="p">[]</span> <span class="n">nonSecretPayload</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">nonSecretPayloadLength</span> <span class="p">=</span> <span class="n">nonSecretPayload</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>

    <span class="c1">//User Error Checks</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">key</span><span class="p">.</span><span class="n">Length</span> <span class="p">!=</span> <span class="n">KEY_BIT_SIZE</span> <span class="p">/</span> <span class="m">8</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Key needs to be {0} bit!&quot;</span><span class="p">,</span> <span class="n">KEY_BIT_SIZE</span><span class="p">),</span> <span class="s">&quot;key&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">encryptedMessage</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">encryptedMessage</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">&quot;Encrypted Message Required!&quot;</span><span class="p">,</span> <span class="s">&quot;encryptedMessage&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cipherStream</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryStream</span><span class="p">(</span><span class="n">encryptedMessage</span><span class="p">))</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">cipherReader</span> <span class="p">=</span> <span class="k">new</span> <span class="n">BinaryReader</span><span class="p">(</span><span class="n">cipherStream</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">//Grab Payload</span>
        <span class="kt">var</span> <span class="n">nonSecretPayloadMsg</span> <span class="p">=</span> <span class="n">cipherReader</span><span class="p">.</span><span class="n">ReadBytes</span><span class="p">(</span><span class="n">nonSecretPayloadLength</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nonSecretPayload</span><span class="p">.</span><span class="n">FromBytes</span><span class="p">()</span> <span class="p">!=</span> <span class="n">nonSecretPayloadMsg</span><span class="p">.</span><span class="n">FromBytes</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="p">(</span><span class="s">&quot;Non Secret Payload Does not Match!&quot;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">//Grab Nonce</span>
        <span class="kt">var</span> <span class="n">nonce</span> <span class="p">=</span> <span class="n">cipherReader</span><span class="p">.</span><span class="n">ReadBytes</span><span class="p">(</span><span class="n">NONCE_BIT_SIZE</span> <span class="p">/</span> <span class="m">8</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">cipher</span> <span class="p">=</span> <span class="k">new</span> <span class="n">GcmBlockCipher</span><span class="p">(</span><span class="k">new</span> <span class="n">AesFastEngine</span><span class="p">());</span>
        <span class="kt">var</span> <span class="n">parameters</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AeadParameters</span><span class="p">(</span><span class="k">new</span> <span class="n">KeyParameter</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">MAC_BIT_SIZE</span><span class="p">,</span> <span class="n">nonce</span><span class="p">,</span> <span class="n">nonSecretPayload</span><span class="p">);</span>
        <span class="n">cipher</span><span class="p">.</span><span class="n">Init</span><span class="p">(</span><span class="k">false</span><span class="p">,</span> <span class="n">parameters</span><span class="p">);</span>

        <span class="c1">//Decrypt Cipher Text</span>
        <span class="kt">var</span> <span class="n">cipherText</span> <span class="p">=</span> <span class="n">cipherReader</span><span class="p">.</span><span class="n">ReadBytes</span><span class="p">(</span><span class="n">encryptedMessage</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="n">nonSecretPayloadLength</span> <span class="p">-</span> <span class="n">nonce</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">plainText</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">cipher</span><span class="p">.</span><span class="n">GetOutputSize</span><span class="p">(</span><span class="n">cipherText</span><span class="p">.</span><span class="n">Length</span><span class="p">)];</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">len</span> <span class="p">=</span> <span class="n">cipher</span><span class="p">.</span><span class="n">ProcessBytes</span><span class="p">(</span><span class="n">cipherText</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">cipherText</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="n">plainText</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
            <span class="n">cipher</span><span class="p">.</span><span class="n">DoFinal</span><span class="p">(</span><span class="n">plainText</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">InvalidCipherTextException</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//Return null if it doesn&#39;t authenticate</span>
            <span class="k">return</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">plainText</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ol class="arabic simple" start="7">
<li><p>The resulting plaintext is then decompressed using GZip and returned.</p></li>
</ol>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../integrations/IDP.html" class="btn btn-neutral float-left" title="Identity Providers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Installing.html" class="btn btn-neutral float-right" title="Installing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Senetas Corporation Limited.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>